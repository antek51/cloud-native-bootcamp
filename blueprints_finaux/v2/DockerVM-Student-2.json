{"status":{},"contains_secrets":true,"product_version":"3.3.1","spec":{"description":"Docker build VM","resources":{"client_attrs":{"None":{"y":149.5,"x":223.5},"b562adc4_deployment":{"y":-538.6276084901,"x":420.0234648315}},"service_definition_list":[{"singleton":false,"action_list":[{"description":"System action for creating an application","type":"system","critical":false,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"DockerVM"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"201bf1d8_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"4b34bc84_runbook","main_task_local_reference":{"kind":"app_task","name":"201bf1d8_dag"},"variable_list":[]},"name":"action_create"},{"description":"System action for deleting an application. Deletes created VMs as well","type":"system","critical":false,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"DockerVM"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"9771a791_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"897d60a6_runbook","main_task_local_reference":{"kind":"app_task","name":"9771a791_dag"},"variable_list":[]},"name":"action_delete"},{"description":"System action for starting an application","type":"system","critical":false,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"DockerVM"},"retries":"0","description":"","child_tasks_local_reference_list":[{"kind":"app_task","name":"Start Docker"}],"name":"af0a7bea_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"DockerVM"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"Start Docker","attrs":{"exit_status":[],"script":"#!\/bin\/bash\n\nsudo systemctl start docker","script_type":"sh","type":"","command_line_args":"","login_credential_local_reference":{"kind":"app_credential","name":"CentOS"}},"timeout_secs":"0","type":"EXEC","variable_list":[]}],"description":"","name":"8b4a8d5c_runbook","main_task_local_reference":{"kind":"app_task","name":"af0a7bea_dag"},"variable_list":[]},"name":"action_start"},{"description":"System action for stopping an application","type":"system","critical":false,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"DockerVM"},"retries":"0","description":"","child_tasks_local_reference_list":[{"kind":"app_task","name":"Stop Docker"}],"name":"178fb5b9_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"DockerVM"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"Stop Docker","attrs":{"exit_status":[],"script":"#!\/bin\/bash\n\nsudo systemctl stop docker","script_type":"sh","type":"","command_line_args":"","login_credential_local_reference":{"kind":"app_credential","name":"CentOS"}},"timeout_secs":"0","type":"EXEC","variable_list":[]}],"description":"","name":"17fc7fe9_runbook","main_task_local_reference":{"kind":"app_task","name":"178fb5b9_dag"},"variable_list":[]},"name":"action_stop"},{"description":"System action for restarting an application","type":"system","critical":false,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"DockerVM"},"retries":"0","description":"","child_tasks_local_reference_list":[{"kind":"app_task","name":"Restart Docker"}],"name":"ad96baec_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"DockerVM"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"Restart Docker","attrs":{"exit_status":[],"script":"#!\/bin\/bash\n\nsudo systemctl restart docker","script_type":"sh","type":"","command_line_args":"","login_credential_local_reference":{"kind":"app_credential","name":"CentOS"}},"timeout_secs":"0","type":"EXEC","variable_list":[]}],"description":"","name":"f46d5c6c_runbook","main_task_local_reference":{"kind":"app_task","name":"ad96baec_dag"},"variable_list":[]},"name":"action_restart"}],"depends_on_list":[],"name":"DockerVM","port_list":[],"tier":"","variable_list":[],"description":""}],"substrate_definition_list":[{"description":"","action_list":[],"type":"AHV_VM","name":"VM","readiness_probe":{"connection_type":"SSH","retries":"5","connection_protocol":"","connection_port":22,"address":"@@{platform.status.resources.nic_list[0].ip_endpoint_list[0].ip}@@","delay_secs":"60","disable_readiness_probe":false,"login_credential_local_reference":{"kind":"app_credential","name":"CentOS"}},"editables":{"create_spec":{"resources":{"nic_list":{},"serial_port_list":{}}}},"os_type":"Linux","create_spec":{"name":"@@{Initiales}@@-docker_VM","resources":{"nic_list":[{"nic_type":"NORMAL_NIC","ip_endpoint_list":[],"network_function_chain_reference":null,"network_function_nic_type":"INGRESS","mac_address":"","subnet_reference":{"kind":"subnet","type":"","name":"","uuid":"aa544f1b-495a-4b25-8c5f-b85a9ed4dfa0"},"type":""}],"serial_port_list":[],"guest_tools":null,"num_vcpus_per_socket":1,"num_sockets":2,"gpu_list":[],"memory_size_mib":8192,"parent_reference":null,"hardware_clock_timezone":"","guest_customization":{"cloud_init":{"meta_data":"","type":"","user_data":"#cloud-config\npreserve_hostname: false\nhostname: @@{Initiales}@@-docker-vm\nssh_pwauth: true\nusers:\n  - name: @@{CentOS.username}@@\n    chpasswd: { expire: False }\n    lock-passwd: false\n    plain_text_passwd: @@{CentOS.secret}@@\n    sudo: ['ALL=(ALL) NOPASSWD:ALL']\n    groups: sudoers\nruncmd:\n  - setenforce 0\n  - sed -i s\/^SELINUX=.*$\/SELINUX=disabled\/ \/etc\/selinux\/config\n  - systemctl disable firewalld\n  - systemctl stop firewalld"},"type":"","sysprep":null},"power_state":"ON","type":"","account_uuid":"36fffa07-891c-4321-a5da-e7daf8bdf44e","boot_config":{"boot_device":{"type":"","disk_address":{"type":"","device_index":0,"adapter_type":"SCSI"}},"type":"","boot_type":"","mac_address":""},"disk_list":[{"data_source_reference":{"kind":"image","type":"","name":"Centos7-Updated","uuid":"0736fb2f-d514-4a0e-bf3d-37b99692d6bf"},"type":"","disk_size_mib":0,"volume_group_reference":null,"device_properties":{"type":"","disk_address":{"type":"","device_index":0,"adapter_type":"SCSI"},"device_type":"DISK"}},{"data_source_reference":null,"type":"","disk_size_mib":102400,"volume_group_reference":null,"device_properties":{"type":"","disk_address":{"type":"","device_index":1,"adapter_type":"SCSI"},"device_type":"DISK"}}]},"availability_zone_reference":null,"backup_policy":null,"type":"","cluster_reference":null,"categories":""},"variable_list":[]}],"credential_definition_list":[{"username":"centos","description":"","type":"PASSWORD","secret":{"attrs":{"is_secret_modified":true,"secret_reference":{}},"value":"xR5F5sdJE+YkY+rEJ3eA9lLhFdLdcE2olFu4j+yCjuutkZeQRRN8Zb\/l:utf-8"},"name":"CentOS","cred_class":"static"}],"package_definition_list":[{"description":"","action_list":[],"type":"DEB","service_local_reference_list":[{"kind":"app_service","name":"DockerVM"}],"name":"Installation Docker VM","version":"","options":{"install_runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_package","name":"Installation Docker VM"},"retries":"0","description":"","child_tasks_local_reference_list":[{"kind":"app_task","name":"Run Update CentOS"},{"kind":"app_task","name":"Preparation for Docker"},{"kind":"app_task","name":"Install Docker"},{"kind":"app_task","name":"Reboot"},{"kind":"app_task","name":"Waiting for reboot"},{"kind":"app_task","name":"Test reboot"},{"kind":"app_task","name":"AuthorizePrivateRegistry"},{"kind":"app_task","name":"Add K8S Tools"}],"name":"870bda0b_dag","attrs":{"edges":[{"from_task_reference":{"kind":"app_task","name":"Run Update CentOS"},"edge_type":"user_defined","type":"","to_task_reference":{"kind":"app_task","name":"Preparation for Docker"}},{"from_task_reference":{"kind":"app_task","name":"Preparation for Docker"},"edge_type":"user_defined","type":"","to_task_reference":{"kind":"app_task","name":"Install Docker"}},{"from_task_reference":{"kind":"app_task","name":"Install Docker"},"edge_type":"user_defined","type":"","to_task_reference":{"kind":"app_task","name":"Reboot"}},{"from_task_reference":{"kind":"app_task","name":"Reboot"},"edge_type":"user_defined","type":"","to_task_reference":{"kind":"app_task","name":"Waiting for reboot"}},{"from_task_reference":{"kind":"app_task","name":"Waiting for reboot"},"edge_type":"user_defined","type":"","to_task_reference":{"kind":"app_task","name":"Test reboot"}},{"from_task_reference":{"kind":"app_task","name":"Test reboot"},"edge_type":"user_defined","type":"","to_task_reference":{"kind":"app_task","name":"AuthorizePrivateRegistry"}},{"from_task_reference":{"kind":"app_task","name":"AuthorizePrivateRegistry"},"edge_type":"user_defined","type":"","to_task_reference":{"kind":"app_task","name":"Add K8S Tools"}}],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"DockerVM"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"Run Update CentOS","attrs":{"exit_status":[],"script":"#!\/bin\/bash\n\nsudo yum install epel-release -y\nsudo yum update -y\nsudo yum upgrade -y\n","script_type":"sh","type":"","command_line_args":"","login_credential_local_reference":{"kind":"app_credential","name":"CentOS"}},"timeout_secs":"0","type":"EXEC","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"DockerVM"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"Preparation for Docker","attrs":{"exit_status":[],"script":"#!\/bin\/bash\n\n# Install the needed tools\nsudo yum install -y util-linux git jq\n\n# Create the second disk and use it\nsudo fdisk \/dev\/sdb <<EOF\no\nn\np\n1\n\n\nw \nEOF\n\nsleep 10\n#(\n#echo o # Create a new empty DOS partition table\n#echo n # Add a new partition\n#echo p # Primary partition\n#echo 1 # Partition number\n#echo   # First sector (Accept default: 1)\n#echo   # Last sector (Accept default: varies)\n#echo w # Write changes\n#) | sudo fdisk \/dev\/sdb\n\n# Create ext4 FS\n\nsudo mkfs.ext4 \/dev\/sdb1\nsleep 10\n\n# Create the Docker mountpoints and mount it to the second drive\nsudo mkdir -p \/docker-location\nsudo mount \/dev\/sdb1 \/docker-location\n\n# Add mount point to fstab\ndrive_uuid=$(sudo blkid \/dev\/sdb1 | cut -d \"\\\"\" -f 2)\nsudo echo \"UUID=$drive_uuid    \/docker-location    ext4    defaults    1 3\" | sudo tee -a \/etc\/fstab\n","script_type":"sh","type":"","command_line_args":"","login_credential_local_reference":{"kind":"app_credential","name":"CentOS"}},"timeout_secs":"0","type":"EXEC","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"DockerVM"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"Install Docker","attrs":{"script":"#!\/bin\/bash\n\n# Grab the installaition file\ncurl -fsSL https:\/\/get.docker.com\/ | sh\n\n# stopping docker\nsudo systemctl stop docker\nsleep 10\n\n# Change docker location to the new location\nsudo mkdir -p \/docker-location\/docker\nsudo mkdir -p \/etc\/docker\nsudo touch \/etc\/docker\/daemon.json\necho '{\"data-root\": \"\/docker-location\/docker\",\"storage-driver\": \"overlay2\"}' | sudo tee -a \/etc\/docker\/daemon.json\nsudo rsync -aP \/var\/lib\/docker\/ \/docker-location\/docker\nsudo rm -Rf \/var\/lib\/docker\/\n\nsleep 5\n# Start and enable the docker engine at boot time\nsudo systemctl start docker\nsudo systemctl status docker\nsudo systemctl enable docker\ndocker info\n\n# Adding the centos user to the docker group\nsudo usermod -aG docker @@{CentOS.username}@@\n\n# Install docker-compose\nsudo yum install -y docker-compose ; echo $?\n\nif [\u00a0$? -eq 1 ]\nthen\n\texit 0 \nfi\n","type":"","command_line_args":"","exit_status":[],"script_type":"sh"},"timeout_secs":"0","type":"EXEC","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"DockerVM"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"Reboot","attrs":{"exit_status":[],"script":"# Shutdown and reboot after 1 minute\nsudo shutdown -r --no-wall","script_type":"sh","type":"","command_line_args":"","login_credential_local_reference":{"kind":"app_credential","name":"CentOS"}},"timeout_secs":"0","type":"EXEC","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"DockerVM"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"Waiting for reboot","attrs":{"type":"","interval_secs":90},"timeout_secs":"0","type":"DELAY","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"DockerVM"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"Test reboot","attrs":{"exit_status":[],"script":"#!\/bin\/bash\n\necho \"Boot ok\"","script_type":"sh","type":"","command_line_args":"","login_credential_local_reference":{"kind":"app_credential","name":"CentOS"}},"timeout_secs":"0","type":"EXEC","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"DockerVM"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"AuthorizePrivateRegistry","attrs":{"exit_status":[],"script":"#!\/bin\/bash\n\n#Add unsecure regidstry in docker configuration file\n\ncat \/etc\/docker\/daemon.json | jq '. += { \"insecure-registries\" : [\"@@{Registry}@@:5000\"] }' > \/tmp\/daemon.txt\n\necho \"Verification :\"\ncat \/tmp\/daemon.txt\n\nsudo mv \/tmp\/daemon.txt \/etc\/docker\/daemon.json\n\nsudo systemctl restart docker","script_type":"sh","type":"","command_line_args":"","login_credential_local_reference":{"kind":"app_credential","name":"CentOS"}},"timeout_secs":"0","type":"EXEC","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"DockerVM"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"Add K8S Tools","attrs":{"exit_status":[],"script":"#!\/bin\/bash\n\n#Install Snapd\nsudo yum install epel-release -y\nsudo yum install snapd -y\nsudo systemctl enable --now snapd.socket\nsudo ln -s \/var\/lib\/snapd\/snap \/snap\n\nsudo snap version\n\nsudo snap list\n\n#Install Kubectl\nsudo snap install kubectl --classic\nkubectl version --client\n\n#Install helm\nsudo snap install helm --classic\n\n#Install K9S\n#sudo snap install k9s\ncurl -sS https:\/\/webinstall.dev\/k9s | bash\n","script_type":"sh","type":"","command_line_args":"","login_credential_local_reference":{"kind":"app_credential","name":"CentOS"}},"timeout_secs":"0","type":"EXEC","variable_list":[]}],"description":"","name":"ca963bc1_runbook","main_task_local_reference":{"kind":"app_task","name":"870bda0b_dag"},"variable_list":[]},"type":"","uninstall_runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_package","name":"Installation Docker VM"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"bf06f506_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"11e85c66_runbook","main_task_local_reference":{"kind":"app_task","name":"bf06f506_dag"},"variable_list":[]}},"variable_list":[]}],"app_profile_list":[{"deployment_create_list":[{"type":"GREENFIELD","action_list":[],"name":"b562adc4_deployment","min_replicas":"1","default_replicas":"1","depends_on_list":[],"published_service_local_reference_list":[],"max_replicas":"1","package_local_reference_list":[{"kind":"app_package","name":"Installation Docker VM"}],"substrate_local_reference":{"kind":"app_substrate","name":"VM"},"variable_list":[],"description":""}],"environment_reference_list":[],"patch_list":[],"description":"","action_list":[{"description":"","type":"user","critical":false,"runbook":{"task_definition_list":[{"retries":"0","description":"","child_tasks_local_reference_list":[{"kind":"app_task","name":"Update"}],"name":"c3b6199f_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"DockerVM"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"Update","attrs":{"exit_status":[],"script":"#!\/bin\/bash\n\nsudo yum install epel-release -y\nsudo yum update -y\nsudo yum upgrade -y\n","script_type":"sh","type":"","command_line_args":"","login_credential_local_reference":{"kind":"app_credential","name":"CentOS"}},"timeout_secs":"0","type":"EXEC","variable_list":[]}],"description":"","name":"5ce7a4b6_runbook","main_task_local_reference":{"kind":"app_task","name":"c3b6199f_dag"},"variable_list":[]},"name":"Update OS"}],"name":"Default","restore_config_list":[],"snapshot_config_list":[],"variable_list":[{"regex":{"should_validate":true,"value":"^[A-Z][A-Z][A-Z]?$"},"val_type":"STRING","is_mandatory":true,"description":"","data_type":"BASE","type":"LOCAL","name":"Initiales","value":"XYZ","label":"Vos initiales","attrs":{"type":""},"editables":{"value":true},"is_hidden":false,"options":{"type":"PREDEFINED","choices":[]}},{"val_type":"STRING","is_mandatory":true,"description":"Enter here the IP of the private registry","data_type":"BASE","type":"LOCAL","name":"Registry","value":"","label":"Private Registry","attrs":{"type":""},"editables":{"value":true},"is_hidden":false,"options":{"type":"PREDEFINED","choices":[]}}]}],"published_service_definition_list":[],"default_credential_local_reference":{"kind":"app_credential","name":"CentOS"},"type":"USER"},"name":"DockerVM-Student-2"},"api_version":"3.0","metadata":{"last_update_time":"1638312703267799","kind":"blueprint","spec_version":1,"creation_time":"1638312642341865","name":"DockerVM-Student-2"}}